# Блокировки объектов
**Блокировки** используются, чтобы упорядочить конкурентный доступк разделяемым ресурсам
Под конкурентным доступом понимается одновременный доступ нескольких процессов. Сами процессы могут выполняться как параллельно (если позволяет аппаратура), так и последовательнов режиме разделения времени.Блокировки не нужны, если нет конкуренции (одновременно к данным обращается только один процесс) или если нет разделяемого ресурса (например, общий буферный кеш нуждается в блокировках,а локальный – нет).Перед тем как обратиться к ресурсу, защищенному блокировкой, процесс должен захватить эту блокировку. После того как ресурс больше не нужен процессу, он освобождает блокировку, чтобы ресурсом могли воспользоваться другие процессы.
В данной лабораторной работе последовательно реализованы следующие задачи:
##### 0. Подготовка
Создадим таблицу БД номер счета будет первичным ключом.
```sh
CREATE DATABASE locks_objects;
```
Соеденился с ней и создал там таблицу:
```sh
\c locks_objects
=# CREATE TABLE accounts(acc_no integer PRIMARY KEY, amount numeric);
```
<br>




Вот что получится:

![Снимок экрана (128)](https://user-images.githubusercontent.com/114056557/206900821-5c5da81e-c588-4a20-bac9-d9746e2896d5.png)


##### 1. Блокировки читающей транзакции, Read Committed: <br>
Начинаем транзакцию и читаем одну строку.

![Снимок экрана (129)](https://user-images.githubusercontent.com/114056557/206900662-38100571-c69d-4439-89b0-fa92f969099e.png)

Блокировки:
<br>

![Снимок экрана (130)](https://user-images.githubusercontent.com/114056557/206900881-bca3532b-a50d-4805-a315-b0b30d528d20.png)

<br>
Здесь мы видим:
- Блокировку таблицы accounts в режиме AccessShareLock;
- Блокировку индекса accounts_pkey, созданного для первичного ключа, в том же режиме;
- Исключительную блокировку собственного номера виртуальной транзакции.
<br>
Если смотреть блокировки в самой транзакции, к ним добавится блокировка на таблицу pg_locks:

![Снимок экрана (131)](https://user-images.githubusercontent.com/114056557/206900932-3c3bfdc7-9b7b-4731-bc3b-fccad6681058.png)

##### 2. Повышение уровня предикатных блокировок
В двух сеансах начинаем транзакции с уровнем Serializable:

<br>

![Снимок экрана (132)](https://user-images.githubusercontent.com/114056557/206902268-25879eba-b604-4421-8391-d3da61fa2fdd.png)

 первой читаем строки счетов 1 и 3, во второй – строки счетов 2 и 3:<br>
 
 ![Снимок экрана (133)](https://user-images.githubusercontent.com/114056557/206902295-f65930d8-513c-4a2d-8640-ede3744cc0a9.png)

Блокируются страница индекса и отдельные версии строк:

![Снимок экрана (134)](https://user-images.githubusercontent.com/114056557/206902314-f753fd70-a0c2-4161-aca3-1589e6712747.png)

Изменим в первом сеансе остаток первого счета, во втором – второго.<br>

![Снимок экрана (135)](https://user-images.githubusercontent.com/114056557/206902328-c0df941e-cc6e-4237-aef0-9f6f739000ec.png)

Транзакции сериализуются:<br>

![Снимок экрана (136)](https://user-images.githubusercontent.com/114056557/206902338-fa528bc1-88ff-4078-9d6c-c60b54711ed8.png)

Теперь настроим повышение уровня так, чтобы при блокировке двух версий строк блокировалась вся таблица.<br>

![Снимок экрана (137)](https://user-images.githubusercontent.com/114056557/206902350-7ddc2171-1b3b-4c7b-8fae-1941b1f82ec3.png)

Повторяем:<br>

![Снимок экрана (138)](https://user-images.githubusercontent.com/114056557/206902370-93335985-1a51-4266-99f4-7c3a84439632.png)

Теперь каждая транзакция блокирует всю таблицу:<br>

![Снимок экрана (139)](https://user-images.githubusercontent.com/114056557/206902399-9a234e90-fd47-46df-8389-7e546f723bdf.png)

Завершаем транзакции.<br>
##### 3. Вывод в журнал информации о блокировках
Требуется изменить параметры:<br>

![Снимок экрана (140)](https://user-images.githubusercontent.com/114056557/206902412-7179e6f4-788b-4405-86bb-89524869d44d.png)

Воспроизведем блокировку:<br>

![Снимок экрана (141)](https://user-images.githubusercontent.com/114056557/206902429-1f9a6cae-bef0-4bad-904f-f90ce3a9b490.png)

В первом сеансе выполним задержку и после этого завершим транзакцию:<br>

![Снимок экрана (142)](https://user-images.githubusercontent.com/114056557/206902448-549b6706-91b1-486e-ab36-3ea0093123e9.png)

![Снимок экрана (143)](https://user-images.githubusercontent.com/114056557/206902482-cfca88a9-754d-4a92-ab1a-0b1d34f42c85.png)


Вот что попало в журнал:<br>

![Снимок экрана (144)](https://user-images.githubusercontent.com/114056557/206902471-eadf1898-5b6a-4e3a-a364-3eb09a408265.png)





